# MAI-practice-API-gateway-for-integration-with-banking-systems

Разработка API-шлюза для интеграции с банковскими системами

---

# Техническое задание

## Цель и функциональные требования
- [ ] Разработать API-шлюз для взаимодействия с банковскими системами:
  - [ ] ДБО (Дистанционное банковское обслуживание) – для загрузки документов клиентами.
  - [ ] АБС (Автоматизированная банковская система) – для хранения и
обработки документов.
  - [ ] СМ (Система управления) – для привязки документов к карточкам контрактов.
- [ ] Обеспечить защиту API с использованием OAuth 2.0/JWT.
- [ ] Разработать версионность API для поддержки будущих изменений.

## Выходные артефакты
- [ ] Документ со схемой API, описанием эндпоинтов и форматов запросов.
- [ ] Прототип API-шлюза (FastAPI, PostgreSQL).
- [ ] Тестовый сценарий передачи документов между сервисами.

---

# План выполнения работ

Приведенный ниже план разбит на этапы с метриками для контроля прогресса.

#### **Этап 1: Проектирование**

**Задачи**:

1. **Анализ требований**:
   - [ ] Уточнить форматы данных для ДБО, АБС, СМ (JSON, спецификации полей).
   - [X] Определить роли пользователей и права доступа (например, клиент, администратор).

2. **Схема API**:
   - [ ] Описать эндпоинты для каждой системы:
     - [ ] ДБО: Загрузка документов (`POST /v1/dbo/documents`).
     - [ ] АБС: Получение статуса документа (`GET /v1/abs/documents/{id}`).
     - [ ] СМ: Привязка к контракту (`POST /v1/sm/contracts/{id}/link`).
   - [ ] Форматы запросов/ответов.

3. **Архитектура**:
   - [X] Выбрать FastAPI + PostgreSQL.
   - [X] Спроектировать базу данных (ER-диаграмма).
   - [ ] Решить, как хранить JWT (краткосрочные токены с рефреш-токенами).

**Метрики**:
- [ ] Документ с OpenAPI-спецификацией.
- [X] ER-диаграмма БД.

#### **Этап 2: Разработка базового функционала**

**Задачи**:

1. **Настройка проекта**:
   - [X] Инициализация FastAPI.
   - [ ] Подключение PostgreSQL через SQLAlchemy.
   - [ ] Настройка Alembic для миграций.

2. **Реализация безопасности**:
   - [ ] OAuth2 с JWT: эндпоинт `/token`.
   - [ ] Middleware для проверки токенов.
   - [ ] Ролевая модель (например, `client`, `admin`).

3. **Базовые эндпоинты**:
   - [ ] ДБО: Загрузка документов (сохранение в БД + заглушка для АБС).
   - [ ] АБС: Мок-реализация хранения документов.
   - [ ] СМ: Привязка документа к контракту (проверка существования ID).

**Метрики**:
- [ ] Рабочий прототип на локальной машине.
- [ ] Успешная аутентификация через Postman.

#### **Этап 3: Интеграция с системами**

**Задачи**:

<!-- TODO: Пересмотреть -->
1. **Интеграция с ДБО**:
   - [ ] Реализация загрузки файлов (PDF, DOCX) в хранилище (например, MinIO/S3).

2. **Интеграция с АБС**:
   - [ ] Реализация синхронизации статусов документов (например, `pending`, `approved`).

3. **Интеграция с СМ**:
   - [ ] Привязка документа к карточке контракта (проверка прав доступа).

**Метрики**:
- [ ] Успешная передача документа из ДБО в АБС.
- [ ] Отображение статуса документа в АБС через API.

#### **Этап 4: Тестирование и оптимизация**

**Задачи**:

1. **Нагрузочное тестирование**:
   - [ ] Оптимизация запросов к БД (индексы, кэширование через Redis).

2. **Документация**:
   - [ ] Swagger/Redoc для API.
   - [ ] Руководство для разработчиков (примеры запросов).

**Метрики**:
- [ ] Документация опубликована на SwaggerHub.

### **Стек технологий**
- **Backend**: FastAPI, SQLAlchemy, Pydantic.
- **База данных**: PostgreSQL + Redis (кэш).
- **Безопасность**: OAuth2, JWT, Let’s Encrypt.
- **Инфраструктура**: Docker, Kubernetes, AWS.
- **Тестирование**: pytest, Postman, Locust.

---

# Ход работы

## Проектирование БД под задачу

![alt text](resources/img/DB.png)

#### **1. Fin_pss (Финансовое положение)**
- **Назначение**: Справочник финансовых статусов клиентов (например, "стабильный", "критический", "под наблюдением").
- **Поля**:
  - `id`: Уникальный идентификатор статуса.
  - `pos`: Название статуса.

#### **2. User_type (Тип пользователя)**
- **Назначение**: Определение ролей пользователей (клиент, сотрудник банка, администратор).
- **Поля**:
  - `id`: Уникальный идентификатор роли.
  - `type`: Название роли (например, "клиент", "оператор ДБО").

#### **3. User (Пользователь)**
- **Назначение**: Хранение персональных данных клиентов и сотрудников.
- **Поля**:
  - `id`: Уникальный идентификатор пользователя.
  - `first_name`, `last_name`, `middle_name`: ФИО.
  - `birthday`: Дата рождения.
  - `fin_position_id`: Ссылка на финансовый статус (из Fin_pss).
  - `address`: Адрес проживания.
  - `NN`: Налоговый номер (ИНН).
  - `sec_id`: Пол (требуется уточнение, возможна ошибка в названии).
  - `user_type_id`: Роль пользователя (из User_type).

#### **4. Callcopy (Категория документов)**
- **Назначение**: Классификация документов (например, "паспорт", "договор", "справка о доходах").
- **Поля**:
  - `id`: Уникальный идентификатор категории.
  - `type`: Название категории.

#### **5. Document (Документ)**
- **Назначение**: Хранение метаданных документов, загружаемых через ДБО.
- **Поля**:
  - `id`: Уникальный идентификатор документа.
  - `link`: Ссылка на файл в хранилище (АБС).
  - `description`: Описание документа.
  - `user_id`: Клиент, загрузивший документ.
  - `worker_id`: Сотрудник, обработавший документ.
  - `callcopy_id`: Категория документа (из Callcopy).
  - `actual_date`, `actual_end_date`: Период актуальности документа.
  - `plan_maturity_date`, `fact_maturity_date`: Плановые и фактические сроки обработки.

#### **6. Stat (Статистика загрузки)**
- **Назначение**: Отслеживание статусов загрузки документов.
- **Поля**:
  - `id`: Уникальный идентификатор записи.
  - `user_id`: Клиент.
  - `date`: Дата загрузки.
  - `document_id`: Ссылка на документ.
  - `operation_status_id`: Текущий статус (например, "в обработке", "подтвержден").

#### **7. Operation (Статусы операций)**
- **Назначение**: Справочник возможных статусов операций (например, "успешно", "ошибка", "требует проверки").
- **Поля**:
  - `id`: Уникальный идентификатор статуса.
  - `status`: Название статуса.

#### **8. Contract (Контракты)**
- **Назначение**: Привязка документов к контрактам клиентов (интеграция с СМ).
- **Поля**:
  - `id`: Уникальный идентификатор связи.
  - `user_id`: Клиент.
  - `document_id`: Документ.
  - `operation_status_id`: Статус операции (например, "активен", "архивирован").

### Интеграция:
1. **ДБО**: 
   - Загрузка документов реализуется через таблицу **Document** и **Stat**.
   - Клиенты аутентифицируются через **User** (необходимо добавить поля для логина и пароля).
2. **АБС**: 
   - Хранение документов (поле `link` в **Document**).
   - Обработка документов (поля `worker_id`, `plan_maturity_date`).
3. **СМ**: 
   - Привязка документов к контрактам через таблицу **Contract**.
4. **Защита API**: 
   - Для OAuth 2.0/JWT требуется расширить таблицу **User** (добавить `login`, `password_hash`, `token`).
5. **Версионность API**: 
   - Требуется отдельная таблица для управления версиями (например, **ApiVersion** с полями `version`, `deprecation_date`).


# Эндпоинты и примеры запросов

### Расширенные эндпоинты для систем:

---

#### **1. ДБО (Дистанционное банковское обслуживание)**  
**a. Получение списка документов пользователя**  
**Эндпоинт**: `GET /v1/dbo/users/{user_id}/documents`  
**Назначение**: Просмотр всех документов, загруженных клиентом.  
**Запрос**:  
```http
GET /v1/dbo/users/123/documents HTTP/1.1
Authorization: Bearer <JWT_TOKEN>
```

**Ответ**:  
```json
{
  "documents": [
    {
      "id": 789,
      "description": "Договор аренды",
      "category": "Договоры",
      "upload_date": "2023-10-25",
      "status": "processed"
    },
    {
      "id": 790,
      "description": "Справка о доходах",
      "category": "Финансы",
      "upload_date": "2023-10-26",
      "status": "pending"
    }
  ]
}
```

---

**b. Обновление описания документа**  
**Эндпоинт**: `PATCH /v1/dbo/documents/{id}`  
**Назначение**: Изменение метаданных документа (например, описания).  
**Запрос**:  
```http
PATCH /v1/dbo/documents/789 HTTP/1.1
Authorization: Bearer <JWT_TOKEN>
Content-Type: application/json

{
  "description": "Обновленный договор аренды"
}
```

**Ответ**:  
```json
{
  "document_id": 789,
  "updated_field": "description",
  "new_value": "Обновленный договор аренды"
}
```

---

**c. Удаление документа**  
**Эндпоинт**: `DELETE /v1/dbo/documents/{id}`  
**Назначение**: Удаление документа (если статус позволяет).  
**Запрос**:  
```http
DELETE /v1/dbo/documents/789 HTTP/1.1
Authorization: Bearer <JWT_TOKEN>
```

**Ответ**:  
```json
{
  "message": "Document 789 deleted successfully"
}
```

---

#### **2. АБС (Автоматизированная банковская система)**  
**a. Поиск документов по критериям**  
**Эндпоинт**: `GET /v1/abs/documents`  
**Назначение**: Фильтрация документов по статусу, категории, дате.  
**Запрос**:  
```http
GET /v1/abs/documents?status=processed&category=Договоры HTTP/1.1
Authorization: Bearer <JWT_TOKEN>
```

**Ответ**:  
```json
{
  "results": [
    {
      "id": 789,
      "description": "Договор аренды",
      "worker_id": 456,
      "plan_maturity_date": "2023-11-01"
    }
  ]
}
```

---

**b. Обновление статуса документа сотрудником**  
**Эндпоинт**: `PUT /v1/abs/documents/{id}/status`  
**Назначение**: Изменение статуса обработки документа (например, "в архиве").  
**Запрос**:  
```http
PUT /v1/abs/documents/789/status HTTP/1.1
Authorization: Bearer <JWT_TOKEN>
Content-Type: application/json

{
  "status": "archived",
  "worker_id": 456
}
```

**Ответ**:  
```json
{
  "document_id": 789,
  "new_status": "archived",
  "updated_by": 456
}
```

---

**c. Массовая загрузка документов**  
**Эндпоинт**: `POST /v1/abs/documents/batch`  
**Назначение**: Загрузка нескольких документов для пакетной обработки.  
**Запрос**:  
```http
POST /v1/abs/documents/batch HTTP/1.1
Authorization: Bearer <JWT_TOKEN>
Content-Type: multipart/form-data

{
  "documents": [
    {"user_id": 123, "description": "Справка 1", "callcopy_id": 3},
    {"user_id": 124, "description": "Справка 2", "callcopy_id": 3}
  ],
  "files": [<file1>, <file2>]
}
```

**Ответ**:  
```json
{
  "processed_count": 2,
  "failed_count": 0,
  "document_ids": [790, 791]
}
```

---

#### **3. СМ (Система управления)**  
**a. Создание нового контракта**  
**Эндпоинт**: `POST /v1/sm/contracts`  
**Назначение**: Регистрация нового контракта в системе.  
**Запрос**:  
```http
POST /v1/sm/contracts HTTP/1.1
Authorization: Bearer <JWT_TOKEN>
Content-Type: application/json

{
  "user_id": 123,
  "description": "Контракт на обслуживание"
}
```

**Ответ**:  
```json
{
  "contract_id": 102,
  "user_id": 123,
  "status": "draft"
}
```

---

**b. Просмотр документов контракта**  
**Эндпоинт**: `GET /v1/sm/contracts/{id}/documents`  
**Назначение**: Получение списка документов, привязанных к контракту.  
**Запрос**:  
```http
GET /v1/sm/contracts/101/documents HTTP/1.1
Authorization: Bearer <JWT_TOKEN>
```

**Ответ**:  
```json
{
  "contract_id": 101,
  "documents": [
    {
      "document_id": 789,
      "description": "Договор аренды",
      "link": "https://abs-storage/documents/789.pdf"
    }
  ]
}
```

---

**c. Изменение статуса привязки**  
**Эндпоинт**: `PUT /v1/sm/contracts/{id}/link`  
**Назначение**: Обновление статуса связи (например, "отозвано").  
**Запрос**:  
```http
PUT /v1/sm/contracts/101/link HTTP/1.1
Authorization: Bearer <JWT_TOKEN>
Content-Type: application/json

{
  "document_id": 789,
  "operation_status_id": 4  // Например, 4 = "отозвано"
}
```

**Ответ**:  
```json
{
  "contract_id": 101,
  "document_id": 789,
  "new_status": "revoked"
}
```